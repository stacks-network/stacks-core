name: Cargo Hack Check

on:
  workflow_call:

env:
  RUST_BACKTRACE: full

concurrency:
  group: cargo-hack-check-${{ github.head_ref || github.ref || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # Setup job to prepare common dependencies
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      rust-toolchain: ${{ steps.toolchain.outputs.rust-toolchain }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Get Rust toolchain
        id: toolchain
        run: echo "rust-toolchain=$(cat ./rust-toolchain)" >> $GITHUB_OUTPUT

  # Native targets (Windows/Linux) - now just one job
  native-targets:
    name: All Crates (Windows/Linux)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Rust with Cache
        uses: actions-rust-lang/setup-rust-toolchain@11df97af8e8102fd60b60a77dfbf58d40cd843b8 # v1.10.1
        with:
          toolchain: ${{ needs.setup.outputs.rust-toolchain }}
          cache: true
          cache-key: cargo-hack-native-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-hack
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-hack

      - name: Add native targets
        run: |
          rustup target add x86_64-pc-windows-gnu
          rustup target add x86_64-unknown-linux-gnu

      - name: Install Windows cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-mingw-w64-x86-64

      - name: Run cargo hack check
        run: |
          cargo hack check \
            --all \
            --each-feature \
            --no-dev-deps \
            --exclude-features=wasm-deterministic,wasm-web \
            --target x86_64-pc-windows-gnu \
            --target x86_64-unknown-linux-gnu

  # WASM targets - separate cache since dependencies differ
  wasm-targets:
    name: ${{ matrix.name }}
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Clarity & Stacks-Common WASM Web"
            command: |
              cargo hack check \
                -p clarity \
                -p stacks-common \
                --each-feature \
                --no-dev-deps \
                --exclude-features=default,rusqlite,testing,wasm-deterministic \
                --features=wasm-web \
                --target wasm32-unknown-unknown

          - name: "Clarity & Stacks-Common WASM Deterministic"
            command: |
              cargo hack check \
                -p clarity \
                -p stacks-common \
                --each-feature \
                --no-dev-deps \
                --include-features=wasm-deterministic,slog_json \
                --features=wasm-deterministic \
                --target wasm32-unknown-unknown

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Rust with Cache
        uses: actions-rust-lang/setup-rust-toolchain@11df97af8e8102fd60b60a77dfbf58d40cd843b8 # v1.10.1
        with:
          toolchain: ${{ needs.setup.outputs.rust-toolchain }}
          cache: true
          cache-key: cargo-hack-wasm-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-hack
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-hack

      - name: Add WASM target
        run: rustup target add wasm32-unknown-unknown

      - name: Run cargo hack check
        run: ${{ matrix.command }}

  # Summary job
  check-results:
    name: Check Results
    runs-on: ubuntu-latest
    if: always()
    needs: [native-targets, wasm-targets]
    steps:
      - name: Check Results
        run: |
          if [[ "${{ needs.native-targets.result }}" == "failure" || "${{ needs.wasm-targets.result }}" == "failure" ]]; then
            echo "❌ Some cargo hack checks failed"
            exit 1
          else
            echo "✅ All cargo hack checks passed"
          fi
