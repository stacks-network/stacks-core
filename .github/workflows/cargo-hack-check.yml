name: Cargo Hack Check

on:
  workflow_call:

env:
  RUST_BACKTRACE: full

concurrency:
  group: cargo-hack-check-${{ github.head_ref || github.ref || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  native-check:
    name: Native Check (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux
            target: x86_64-unknown-linux-gnu
          - name: Windows (cross-compile)
            target: x86_64-pc-windows-gnu
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup Rust with Cache
        uses: actions-rust-lang/setup-rust-toolchain@11df97af8e8102fd60b60a77dfbf58d40cd843b8 # v1.10.1
        with:
          target: ${{ matrix.target }}
          toolchain: ${{ needs.setup.outputs.rust-toolchain }}
          cache: true
          cache-key: cargo-hack-${{ matrix.target }}-${{ needs.setup.outputs.rust-toolchain }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-hack
        uses: taiki-e/install-action@2383334cf567d78771fc7d89b6b3802ef1412cf6  # v2.56.8
        with:
          tool: cargo-hack

      - name: Install Windows cross-compilation tools
        if: matrix.target == 'x86_64-pc-windows-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-mingw-w64-x86-64

      - name: Run cargo hack check
        run: |
          cargo hack check \
            --all \
            --each-feature \
            --no-dev-deps \
            --exclude-features=wasm-deterministic,wasm-web \
            --target ${{ matrix.target }}

  # WASM targets - separate cache since dependencies differ
  wasm-targets:
    name: ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Clarity & Stacks-Common WASM Web"
            command: |
              cargo hack check \
                -p clarity \
                -p stacks-common \
                --each-feature \
                --no-dev-deps \
                --exclude-features=default,rusqlite,testing,wasm-deterministic \
                --features=wasm-web \
                --target wasm32-unknown-unknown

          - name: "Clarity & Stacks-Common WASM Deterministic"
            command: |
              cargo hack check \
                -p clarity \
                -p stacks-common \
                --each-feature \
                --no-dev-deps \
                --include-features=wasm-deterministic,slog_json \
                --features=wasm-deterministic \
                --target wasm32-unknown-unknown

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup Rust with Cache
        uses: actions-rust-lang/setup-rust-toolchain@11df97af8e8102fd60b60a77dfbf58d40cd843b8 # v1.10.1
        with:
          toolchain: ${{ needs.setup.outputs.rust-toolchain }}
          target: wasm32-unknown-unknown
          cache: true
          cache-key: cargo-hack-wasm-${{ matrix.name }}-${{ needs.setup.outputs.rust-toolchain }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-hack
        uses: taiki-e/install-action@2383334cf567d78771fc7d89b6b3802ef1412cf6 # v2.56.8
        with:
          tool: cargo-hack

      - name: Run cargo hack check
        run: ${{ matrix.command }}
